package ${normalizedName};

import com.github.maximtereshchenko.conveyor.common.api.*;
import com.github.maximtereshchenko.conveyor.plugin.api.*;

import java.io.*;
import java.nio.file.*;
import java.util.*;
import java.util.stream.*;

public final class ${normalizedName} implements ConveyorPlugin {

    @Override
    public String name() {
        return "${name}";
    }

    @Override
    public List<ConveyorTaskBinding> bindings(ConveyorSchematic schematic, Map<String, String> configuration) {
        return List.of(
            new ConveyorTaskBinding(
                Stage.COMPILE,
                Step.RUN,
                new Task(schematic, configuration)
            )
        );
    }

    private static final class Task implements ConveyorTask {

        private final ConveyorSchematic schematic;
        private final Map<String, String> configuration;

        Task(ConveyorSchematic schematic, Map<String, String> configuration) {
            this.schematic = schematic;
            this.configuration = configuration;
        }

        @Override
        public String name() {
            return "";
        }

        @Override
        public Optional<Path> execute() {
            writeConfiguration(schematic, configuration);
            return Optional.empty();
        }

        private void writeConfiguration(ConveyorSchematic schematic, Map<String, String> configuration) {
            try {
                Files.writeString(
                    schematic.path().getParent().resolve("configuration"),
                    configuration.entrySet()
                        .stream()
                        .map(Map.Entry::toString)
                        .collect(Collectors.joining(System.lineSeparator()))
                );
            } catch (IOException e) {
                throw new UncheckedIOException(e);
            }
        }
    }
}
